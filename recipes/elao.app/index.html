<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">

        <!-- Enable responsiveness on mobile devices-->
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

        <title>    Manala Recipes - Elao - App
</title>

                    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,300,600,700|Sacramento|Inconsolata:400,700' rel='stylesheet' type='text/css'>
            <link rel="stylesheet" href="/manala-recipes/build/app.6e1927d4.css">
        
                    <script src="/manala-recipes/build/runtime.e4df57b3.js" defer></script><script src="/manala-recipes/build/app.4fe7be59.js" defer></script>
            </head>
    <body>

        <header class="header">
            <div class="navbar">
    <div class="container">
        <a href="/manala-recipes/" class="logo">Manala recipes</a>
        <nav>
            <ul>
                <li><a href="https://github.com/manala/manala-recipes">Github</a></li>
                <li>
                    <div class="dropdown">
                        <a class="dropdown-toggle" href="/manala-recipes/">Recipes</a>
                        <div class="dropdown-menu">
                                                            <a class="dropdown-item" href="/manala-recipes/recipes/elao.app.docker">Elao - App - Docker</a>
                                                            <a class="dropdown-item" href="/manala-recipes/recipes/elao.app">Elao - App</a>
                                                            <a class="dropdown-item" href="/manala-recipes/recipes/lazy.ansible">Lazy - Ansible</a>
                                                            <a class="dropdown-item" href="/manala-recipes/recipes/lazy.kubernetes">Lazy - Kubernetes</a>
                                                            <a class="dropdown-item" href="/manala-recipes/recipes/lazy.symfony">Lazy - Symfony</a>
                                                    </div>
                    </div>
                </li>
            </ul>
        </nav>
    </div>
</div>

            <div class="container">
                <div class="row">
                    <div class="col-sm-4">
                        <div class="manala">
                            <div class="circle circle-1"></div>
                            <div class="circle circle-2"></div>
                            <div class="circle circle-3"></div>
                            <div class="circle circle-4"></div>
                            <div class="circle circle-5"></div>
                            <div class="circle circle-6"></div>
                            <img src="/manala-recipes/build/images/arms.b7d6de72.svg" class="arms" alt="Manala">
                            <img src="/manala-recipes/build/images/manala.053e7ef8.svg" class="head" alt="Manala">
                        </div>
                    </div>
                    <div class="lead col-sm-8">
                        <p>Recipes for your projects</p>
                    </div>
                </div>
            </div>
        </header>

        <div class="container">
                <h1>Elao - App</h1>

            <ul>
                            <li>
                    <a href="#requirements">Requirements</a>
                                    </li>
                            <li>
                    <a href="#overview">Overview</a>
                                    </li>
                            <li>
                    <a href="#init">Init</a>
                                    </li>
                            <li>
                    <a href="#quick-start">Quick start</a>
                                    </li>
                            <li>
                    <a href="#vm-interaction">VM interaction</a>
                                    </li>
                            <li>
                    <a href="#system">System</a>
                                    </li>
                            <li>
                    <a href="#integration">Integration</a>
                                            <ul class="sub-list">
                                                            <li><a href="#jenkins">Jenkins</a></li>
                                                            <li><a href="#github-actions">Github Actions</a></li>
                                                            <li><a href="#common-integration-tasks">Common integration tasks</a></li>
                                                    </ul>
                                    </li>
                            <li>
                    <a href="#releases">Releases</a>
                                    </li>
                            <li>
                    <a href="#makefile">Makefile</a>
                                            <ul class="sub-list">
                                                            <li><a href="#git-tools">Git tools</a></li>
                                                            <li><a href="#try-tools">Try tools</a></li>
                                                    </ul>
                                    </li>
                            <li>
                    <a href="#secrets">Secrets</a>
                                    </li>
                            <li>
                    <a href="#https">Https</a>
                                    </li>
                            <li>
                    <a href="#tips-tricks-and-tweaks">Tips, Tricks, and Tweaks</a>
                                    </li>
                    </ul>
    
        <section>
        <header><h2>Migrations</h2></header>
        <article>
            If you're coming from a previous version of the recipe or another recipe, you might be interested reading the following migration guides:

            <ul>
                                <li>
                    <a href="/manala-recipes/migrations/elao.app/MIGRATION.2021-04">
                        Migration - 2021-04
                    </a>
                </li>
                            </ul>
        </article>
    </section>
    
    <section>
        <article>
            <body><h2 id="requirements">Requirements<a href="#requirements" class="anchor"></a></h2>
<ul>
<li>Make</li>
<li>Vagrant 2.2.10+</li>
<li>Landrush 1.3.2+</li>
<li>VirtualBox 6.1.12+</li>
<li>Docker Desktop 2.2.0+</li>
</ul>
<h2 id="overview">Overview<a href="#overview" class="anchor"></a></h2>
<p>This recipe contains some helpful scripts in the context of a php/nodejs app, such as Makefile tasks in order to release and deploy your app.</p>
<h2 id="init">Init<a href="#init" class="anchor"></a></h2>
<pre class="code-multiline"><code id="d770455ce9ab4ff2143db1f7eed39fba">$ cd [workspace]
$ manala init -i elao.app [project]</code></pre>
<h2 id="quick-start">Quick start<a href="#quick-start" class="anchor"></a></h2>
<p>In a shell terminal, change directory to your app, and run the following commands:</p>
<pre class="code-multiline language-shell"><code class="language-shell" id="aca5cb8e0fce2d5de8ea4ed6cb5c590a"><span class="token builtin class-name">cd</span> /path/to/my/app
manala init
Select the <span class="token string">"elao.app"</span> recipe</code></pre>
<p>Edit the <code class="code-inline" id="b67911656ef5d18c4ae36cb6741b7965">Makefile</code> at the root directory of your project and add the following lines at the beginning of the file:</p>
<pre class="code-multiline language-makefile"><code class="language-makefile" id="9373f17e5e68c64fb38756e6ecd46f7d"><span class="token builtin-target builtin">.SILENT</span><span class="token punctuation">:</span>

<span class="token keyword">-include</span> .manala/Makefile</code></pre>
<p>Then update the <code class="code-inline" id="b02a9fece427527328ec7bdc57422dda">.manala.yaml</code> file (see <a href="#releases">the releases example</a> below) and then run the <code class="code-inline" id="5dd555b7998ff20d65ca5d7bc7328329">manala up</code> command:</p>
<pre class="code-multiline language-shell"><code class="language-shell" id="5dd555b7998ff20d65ca5d7bc7328329">manala up</code></pre>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>
    Don't forget to run the <code class="code-inline" id="5dd555b7998ff20d65ca5d7bc7328329">manala up</code> command each time you update the
    <code class="code-inline" id="b02a9fece427527328ec7bdc57422dda">.manala.yaml</code> file to actually apply your changes !!!
</p>
</div>
<p>From now on, if you execute the <code class="code-inline" id="1e44bdd89936c3da837c09c086678c89">make help</code> command in your console, you should obtain the following output:</p>
<pre class="code-multiline language-shell"><code class="language-shell" id="ce3b4a17aa39417b1cc03b30188cbe40">Usage: <span class="token function">make</span> <span class="token punctuation">[</span>target<span class="token punctuation">]</span>

Help:
  <span class="token builtin class-name">help</span> This <span class="token builtin class-name">help</span>

Docker:
  <span class="token function">docker</span> Run <span class="token function">docker</span> container

App:</code></pre>
<h2 id="vm-interaction">VM interaction<a href="#vm-interaction" class="anchor"></a></h2>
<p>In your app directory.</p>
<p>Initialise your app:</p>
<pre class="code-multiline language-bash"><code class="language-bash" id="4fd2c64dcfff0125ebf36e5089c49f7c"><span class="token function">make</span> setup</code></pre>
<p>Start VM:</p>
<pre class="code-multiline language-bash"><code class="language-bash" id="2e9d335be8c5d384ed7b6df0a31c9696"><span class="token function">make</span> up</code></pre>
<p>Stop VM:</p>
<pre class="code-multiline language-bash"><code class="language-bash" id="18a4b187ddd402eeaff3210c41b411d9"><span class="token function">make</span> <span class="token function">halt</span></code></pre>
<p>VM shell:</p>
<pre class="code-multiline language-bash"><code class="language-bash" id="fb6dad9a920a0351eb8c4ff9a6284dfd"><span class="token function">make</span> <span class="token function">ssh</span></code></pre>
<p>Box update:</p>
<pre class="code-multiline language-bash"><code class="language-bash" id="98afaecc287e7d6b0aeb95f9cdef49b5"><span class="token builtin class-name">cd</span> .manala <span class="token operator">&amp;&amp;</span> vagrant box update <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> -</code></pre>
<h2 id="system">System<a href="#system" class="anchor"></a></h2>
<p>Here is an example of a system configuration in <code class="code-inline" id="b02a9fece427527328ec7bdc57422dda">.manala.yaml</code>:</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="c1e81657dad6ec5ab46493492c9d6831"><span class="token comment">##########</span>
<span class="token comment"># System #</span>
<span class="token comment">##########</span>

<span class="token key atrule">system</span><span class="token punctuation">:</span>
    <span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token number">10</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> app.vm
    <span class="token comment">#memory: 4096 # Optional</span>
    <span class="token comment">#cpus: 2 # Optional</span>
    <span class="token comment">#motd: # Optional</span>
    <span class="token comment">#    template: motd/cow.j2</span>
    <span class="token comment">#    message: Foo bar</span>
    <span class="token comment">#timezone: Etc/UTC # Optional</span>
    <span class="token comment">#locales: # Optional</span>
    <span class="token comment">#    default: C.UTF-8</span>
    <span class="token comment">#    codes: []</span>
    <span class="token comment">#env: # Optional</span>
    <span class="token comment">#    FOO: bar</span>
    <span class="token key atrule">apt</span><span class="token punctuation">:</span>
        <span class="token comment">#repositories: [] # Optional</span>
        <span class="token comment">#preferences: [] # Optional</span>
        <span class="token key atrule">packages</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> pdftk
          <span class="token punctuation">-</span> https<span class="token punctuation">:</span>//github.com/wkhtmltopdf/wkhtmltopdf/releases/download/0.12.5/wkhtmltox_0.12.5<span class="token punctuation">-</span>1.stretch_amd64.deb
    <span class="token key atrule">files</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /srv/app/var/log
        <span class="token key atrule">src</span><span class="token punctuation">:</span> /srv/log
        <span class="token key atrule">state</span><span class="token punctuation">:</span> link_directory
      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /srv/app/var/cache
        <span class="token key atrule">src</span><span class="token punctuation">:</span> /srv/cache
        <span class="token key atrule">state</span><span class="token punctuation">:</span> link_directory
      <span class="token comment">#- path: /srv/app/var/sessions</span>
      <span class="token comment">#  src: /srv/sessions</span>
      <span class="token comment">#  state: link_directory</span>
      <span class="token comment">## Api</span>
      <span class="token comment">#- path: /srv/app/api/var/log</span>
      <span class="token comment">#  src: /srv/log/api</span>
      <span class="token comment">#  state: link_directory</span>
      <span class="token comment">#- path: /srv/app/api/var/cache</span>
      <span class="token comment">#  src: /srv/cache/api</span>
      <span class="token comment">#  state: link_directory</span>
    <span class="token comment">#network: # Optional</span>
    <span class="token comment">#    hosts:</span>
    <span class="token comment">#        127.0.0.1: foo.fr foobar.fr</span>
    <span class="token key atrule">nginx</span><span class="token punctuation">:</span>
        <span class="token key atrule">configs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment"># configs:</span>
        <span class="token comment">#     - template: nginx/gzip.j2</span>
        <span class="token comment">#     #- template: nginx/cors.j2</span>
        <span class="token comment">#     #- template: nginx/no_index.j2</span>
        <span class="token comment">#     - template: nginx/php_fpm_app.j2</span>
        <span class="token comment">#     # App</span>
        <span class="token comment">#     - file: app.conf</span>
        <span class="token comment">#       config: |</span><span class="token scalar string">
        #           server {
        #               server_name ~.;
        #               root /srv/app/public;
        #               access_log /srv/log/nginx.access.log;
        #               error_log /srv/log/nginx.error.log;
        #               include conf.d/gzip;
        #               location / {
        #                   try_files $uri /index.php$is_args$args;
        #               }
        #               location ~ ^/index\.php(/|$) {
        #                   include conf.d/php_fpm_app;
        #                   internal;
        #               }
        #           }</span>
    <span class="token key atrule">php</span><span class="token punctuation">:</span>
        <span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token number">8.1</span>
        <span class="token comment"># composer:</span>
        <span class="token comment">#   version: 1 # Optional</span>
        <span class="token key atrule">extensions</span><span class="token punctuation">:</span>
          <span class="token comment"># Symfony</span>
          <span class="token punctuation">-</span> intl
          <span class="token punctuation">-</span> curl
          <span class="token punctuation">-</span> mbstring
          <span class="token punctuation">-</span> xml
          <span class="token comment"># App</span>
          <span class="token punctuation">-</span> mysql
        <span class="token key atrule">configs</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">template</span><span class="token punctuation">:</span> php/opcache.ini.j2
          <span class="token punctuation">-</span> <span class="token key atrule">template</span><span class="token punctuation">:</span> php/app.ini.j2
            <span class="token key atrule">config</span><span class="token punctuation">:</span>
                <span class="token key atrule">date.timezone</span><span class="token punctuation">:</span> UTC
                <span class="token key atrule">upload_max_filesize</span><span class="token punctuation">:</span> 16M
                <span class="token key atrule">post_max_size</span><span class="token punctuation">:</span> 16M
    <span class="token key atrule">nodejs</span><span class="token punctuation">:</span>
        <span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token number">16</span>
        <span class="token comment"># packages:</span>
        <span class="token comment">#   - package: mjml</span>
        <span class="token comment">#     version: 4.6.3</span>
    <span class="token comment"># cron:</span>
    <span class="token comment">#     files:</span>
    <span class="token comment">#       - file: app</span>
    <span class="token comment">#         env:</span>
    <span class="token comment">#           HOME: /srv/app</span>
    <span class="token comment">#         jobs:</span>
    <span class="token comment">#           # Foo - Bar</span>
    <span class="token comment">#           - command: php bin/console app:foo:bar --no-interaction -vv &gt;&gt; /srv/log/cron.foo-bar.log 2&gt;&amp;1</span>
    <span class="token comment">#             minute: 0</span>
    <span class="token comment">#             # Dev</span>
    <span class="token comment">#             state: absent</span>
    <span class="token comment"># supervisor:</span>
    <span class="token comment">#     configs:</span>
    <span class="token comment">#       - file: app.conf</span>
    <span class="token comment">#         #groups:</span>
    <span class="token comment">#         #    acme:</span>
    <span class="token comment">#         #        programs:</span>
    <span class="token comment">#         #          - foo</span>
    <span class="token comment">#         #          - bar</span>
    <span class="token comment">#         programs:</span>
    <span class="token comment">#             foo:</span>
    <span class="token comment">#                 command: php bin/console app:acme:foo --no-interaction -vv</span>
    <span class="token comment">#                 directory: /srv/app</span>
    <span class="token comment">#                 stdout_logfile: /srv/log/supervisor.acme-foo.log</span>
    <span class="token comment">#             bar:</span>
    <span class="token comment">#                 command: php bin/console app:acme:bar --no-interaction -vv</span>
    <span class="token comment">#                 directory: /srv/app</span>
    <span class="token comment">#                 stdout_logfile: /srv/log/supervisor.acme-bar.log</span>
    <span class="token comment">#             foo-bar:</span>
    <span class="token comment">#                 command: php bin/console app:foo:bar --no-interaction -vv</span>
    <span class="token comment">#                 directory: /srv/app</span>
    <span class="token comment">#                 stdout_logfile: /srv/log/supervisor.foo-bar.log</span>
    <span class="token comment">#       - file: app_foo.conf</span>
    <span class="token comment">#         config: |</span><span class="token scalar string">
    #             [program:foo]
    #             command=/bin/foo
    # MariaDB
    mariadb:
        version: 10.6
    # ...*OR* MySQL...
    mysql:
        version: "8.0"
    # redis:
    #     version: "*"
    #     # config:
    #     #     save: '""' # Disable persistence
    elasticsearch:
        version: 7
        plugins:
          - analysis-icu
    # influxdb:
    #     version: "*"
    #     config:
    #       reporting-disabled: true
    #     databases:
    #       - app
    #     users:
    #       - database: app
    #         name: app
    #         password: app
    #     privileges:
    #       - database: app
    #         user: app
    #         grant: ALL
    # mongodb:
    #     version: 4.4
    ssh:
        client:
            config: |
                Host *.elao.run
                    User app
                    ForwardAgent yes</span></code></pre>
<h2 id="integration">Integration<a href="#integration" class="anchor"></a></h2>
<h3 id="jenkins">Jenkins<a href="#jenkins" class="anchor"></a></h3>
<p>Here are some examples of integration configurations in <code class="code-inline" id="b02a9fece427527328ec7bdc57422dda">.manala.yaml</code> for Jenkins:</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="ac20e7dd52ce8d45320e8fa8aa1d3bfa"><span class="token comment">###############</span>
<span class="token comment"># Integration #</span>
<span class="token comment">###############</span>

<span class="token key atrule">integration</span><span class="token punctuation">:</span>
    <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">shell</span><span class="token punctuation">:</span> make install@integration
      <span class="token punctuation">-</span> <span class="token key atrule">label</span><span class="token punctuation">:</span> Integration
        <span class="token key atrule">junit</span><span class="token punctuation">:</span> report/junit/<span class="token important">*.xml</span>
        <span class="token key atrule">parallel</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">warn</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">label</span><span class="token punctuation">:</span> Lint
            <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token key atrule">shell</span><span class="token punctuation">:</span> make lint.php<span class="token punctuation">-</span>cs<span class="token punctuation">-</span>fixer@integration
              <span class="token punctuation">-</span> <span class="token key atrule">shell</span><span class="token punctuation">:</span> make lint.twig@integration
              <span class="token punctuation">-</span> <span class="token key atrule">shell</span><span class="token punctuation">:</span> make lint.yaml@integration
              <span class="token punctuation">-</span> <span class="token key atrule">shell</span><span class="token punctuation">:</span> make lint.eslint@integration
          <span class="token punctuation">-</span> <span class="token key atrule">label</span><span class="token punctuation">:</span> Security
            <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token key atrule">shell</span><span class="token punctuation">:</span> make security.symfony@integration
              <span class="token punctuation">-</span> <span class="token key atrule">shell</span><span class="token punctuation">:</span> make security.yarn@integration
          <span class="token punctuation">-</span> <span class="token key atrule">label</span><span class="token punctuation">:</span> Test
            <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token key atrule">shell</span><span class="token punctuation">:</span> make test.phpunit@integration
                <span class="token key atrule">artifacts</span><span class="token punctuation">:</span> var/log/<span class="token important">*.log</span>
                <span class="token comment"># artifacts:</span>
                <span class="token comment">#   - var/log/foo.log</span>
                <span class="token comment">#   - var/log/bar.log</span>
                <span class="token comment"># env:</span>
                <span class="token comment">#     DATABASE_URL: mysql://root@127.0.0.1:3306/app</span></code></pre>
<p>In this example we have two parallel stages: <code class="code-inline" id="8a5da52ed126447d359e70c05721a8aa">api</code> and <code class="code-inline" id="532c28d5412dd75bf975fb951c740a30">mobile</code>, corresponding to two different sub-apps.</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="e41f8490e6e309d6a46f5556bed8c19a"><span class="token comment">###############</span>
<span class="token comment"># Integration #</span>
<span class="token comment">###############</span>

<span class="token key atrule">integration</span><span class="token punctuation">:</span>
    <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">label</span><span class="token punctuation">:</span> Integration <span class="token comment"># Optional</span>
        <span class="token key atrule">parallel</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># ! Careful ! Could *NOT* be nested !</span>
        <span class="token key atrule">junit</span><span class="token punctuation">:</span> report/junit/<span class="token important">*.xml</span>
        <span class="token key atrule">artifacts</span><span class="token punctuation">:</span> var/log/<span class="token important">*.log</span>
        <span class="token key atrule">warn</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># Turn errors into warnings (recursively applied)</span>
        <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">app</span><span class="token punctuation">:</span> api <span class="token comment"># Optional</span>
            <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token key atrule">shell</span><span class="token punctuation">:</span> make install@integration
              <span class="token punctuation">-</span> <span class="token key atrule">shell</span><span class="token punctuation">:</span> make build@integration
              <span class="token punctuation">-</span> <span class="token key atrule">shell</span><span class="token punctuation">:</span> make lint.php<span class="token punctuation">-</span>cs<span class="token punctuation">-</span>fixer@integration
              <span class="token punctuation">-</span> <span class="token key atrule">shell</span><span class="token punctuation">:</span> make security.symfony@integration
              <span class="token punctuation">-</span> <span class="token key atrule">shell</span><span class="token punctuation">:</span> make test.phpunit@integration
                <span class="token key atrule">artifacts</span><span class="token punctuation">:</span> var/log/<span class="token important">*.log</span>
                <span class="token comment"># env:</span>
                <span class="token comment">#     DATABASE_URL: mysql://root@127.0.0.1:3306/app</span>
          <span class="token punctuation">-</span> <span class="token key atrule">app</span><span class="token punctuation">:</span> mobile
            <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token key atrule">shell</span><span class="token punctuation">:</span> make install@integration
              <span class="token punctuation">-</span> <span class="token key atrule">shell</span><span class="token punctuation">:</span> make build@integration
              <span class="token punctuation">-</span> <span class="token key atrule">shell</span><span class="token punctuation">:</span> make lint.eslint@integration
              <span class="token punctuation">-</span> <span class="token key atrule">shell</span><span class="token punctuation">:</span> make test.jest@integration</code></pre>
<h3 id="github-actions">Github Actions<a href="#github-actions" class="anchor"></a></h3>
<p>The recipes generates a <code class="code-inline" id="3254677a7917c6c01f55212f86c57fbf">Dockerfile</code> and a <code class="code-inline" id="eb672b1ddd3aa7dae5f2577f38daa271">docker-compose.yaml</code> file that can
be used to provide a fully-fledged environnement according to your project needs.</p>
<p>The <a href="https://github.com/Elao/manala-ci-action" target="_blank">Elao/manala-ci-action</a> rely on
this to allow you running any CLI command in this environnement,
using Github Action workflows.</p>
<h3 id="common-integration-tasks">Common integration tasks<a href="#common-integration-tasks" class="anchor"></a></h3>
<p>Add in your <code class="code-inline" id="b67911656ef5d18c4ae36cb6741b7965">Makefile</code>:</p>
<pre class="code-multiline language-makefile"><code class="language-makefile" id="47b245d62a5a426fee968acfc64942da"><span class="token comment">###########</span>
<span class="token comment"># Install #</span>
<span class="token comment">###########</span>

...

<span class="token target symbol">install@integration</span><span class="token punctuation">:</span> <span class="token keyword">export</span> APP_ENV <span class="token operator">=</span> test
<span class="token target symbol">install@integration</span><span class="token punctuation">:</span>
    <span class="token comment"># Composer</span>
    composer install --ansi --verbose --no-interaction --no-progress --prefer-dist --optimize-autoloader --no-scripts --ignore-platform-reqs
    <span class="token comment">#composer run-script symfony-scripts --ansi --verbose --no-interaction</span>
    <span class="token comment"># Npm</span>
    npm install --color<span class="token operator">=</span>always --no-progress --no-audit
    <span class="token comment"># Yarn</span>
    yarn install --color<span class="token operator">=</span>always --no-progress

<span class="token comment">###########</span>
<span class="token comment"># Build #</span>
<span class="token comment">###########</span>

...

<span class="token target symbol">build@integration</span><span class="token punctuation">:</span>
    <span class="token comment"># Webpack Encore</span>
    npx encore production --color<span class="token operator">=</span>always --no-progress

<span class="token comment">########</span>
<span class="token comment"># Lint #</span>
<span class="token comment">########</span>

...

<span class="token target symbol">lint.php-cs-fixer@integration</span><span class="token punctuation">:</span>
    mkdir -p report/junit
    vendor/bin/php-cs-fixer fix --dry-run --diff --format<span class="token operator">=</span>junit &gt; report/junit/php-cs-fixer.xml

<span class="token target symbol">lint.phpstan@integration</span><span class="token punctuation">:</span>
    mkdir -p report/junit
    vendor/bin/phpstan --error-format<span class="token operator">=</span>junit --no-progress --no-interaction analyse &gt; report/junit/phpstan.xml

<span class="token target symbol">lint.twig@integration</span><span class="token punctuation">:</span>
<span class="token target symbol">    bin/console lint</span><span class="token punctuation">:</span>twig templates --ansi --no-interaction

<span class="token target symbol">lint.yaml@integration</span><span class="token punctuation">:</span>
<span class="token target symbol">    bin/console lint</span><span class="token punctuation">:</span>yaml config translations --ansi --no-interaction

<span class="token target symbol">lint.eslint@integration</span><span class="token punctuation">:</span>
    npx eslint src --format junit --output-file report/junit/eslint.xml

<span class="token target symbol">lint.stylelint@integration</span><span class="token punctuation">:</span>
    mkdir -p report/junit
    npx stylelint <span class="token string">"assets/styles/**/*.scss"</span> \
        --syntax scss \
        --custom-formatter <span class="token string">"node_modules/stylelint-junit-formatter"</span> \
        &gt; report/junit/stylelint.xml

<span class="token target symbol">lint.flow@integration</span><span class="token punctuation">:</span>
    mkdir -p report/junit
    npx flow check --json <span class="token operator">|</span> npx flow-junit-transformer &gt; report/junit/flow.xml

<span class="token comment">############</span>
<span class="token comment"># Security #</span>
<span class="token comment">############</span>

...

<span class="token target symbol">security.symfony@integration</span><span class="token punctuation">:</span>
<span class="token target symbol">    symfony check</span><span class="token punctuation">:</span>security

<span class="token target symbol">security.yarn@integration</span><span class="token punctuation">:</span>
    yarn audit <span class="token punctuation">;</span> RC<span class="token operator">=</span><span class="token variable">$$</span><span class="token punctuation">{</span>?<span class="token punctuation">}</span> <span class="token punctuation">;</span> [ <span class="token variable">$$</span><span class="token punctuation">{</span>RC<span class="token punctuation">}</span> -gt 2 ] &amp;&amp; exit <span class="token variable">$$</span><span class="token punctuation">{</span>RC<span class="token punctuation">}</span> <span class="token operator">|</span><span class="token operator">|</span> exit 0

<span class="token target symbol">security.npm@integration</span><span class="token punctuation">:</span>
    npm audit --audit-level moderate

<span class="token comment">########</span>
<span class="token comment"># Test #</span>
<span class="token comment">########</span>

...

<span class="token target symbol">test.phpunit@integration</span><span class="token punctuation">:</span> <span class="token keyword">export</span> APP_ENV <span class="token operator">=</span> test
<span class="token target symbol">test.phpunit@integration</span><span class="token punctuation">:</span>
    <span class="token comment"># Db</span>
<span class="token target symbol">    bin/console doctrine</span><span class="token punctuation">:</span>database<span class="token punctuation">:</span>create --ansi
<span class="token target symbol">    bin/console doctrine</span><span class="token punctuation">:</span>schema<span class="token punctuation">:</span>create --ansi
    <span class="token comment"># PHPUnit</span>
    bin/phpunit --colors<span class="token operator">=</span>always --log-junit report/junit/phpunit.xml

<span class="token target symbol">test.jest@integration</span><span class="token punctuation">:</span> <span class="token keyword">export</span> JEST_JUNIT_OUTPUT_DIR <span class="token operator">=</span> report/junit
<span class="token target symbol">test.jest@integration</span><span class="token punctuation">:</span> <span class="token keyword">export</span> JEST_JUNIT_OUTPUT_NAME <span class="token operator">=</span> jest.xml
<span class="token target symbol">test.jest@integration</span><span class="token punctuation">:</span>
    npx jest --ci --color --reporters<span class="token operator">=</span>default --reporters<span class="token operator">=</span>jest-junit</code></pre>
<h2 id="releases">Releases<a href="#releases" class="anchor"></a></h2>
<p>Here is an example of a production/staging release configuration in <code class="code-inline" id="b02a9fece427527328ec7bdc57422dda">.manala.yaml</code>:</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="3152e346468f7462e3d3e583e29a83d6"><span class="token comment">############</span>
<span class="token comment"># Releases #</span>
<span class="token comment">############</span>

<span class="token key atrule">releases</span><span class="token punctuation">:</span>

  <span class="token punctuation">-</span> <span class="token important">&amp;release</span>
    <span class="token comment">#app: api # Optional</span>
    <span class="token key atrule">mode</span><span class="token punctuation">:</span> production
    <span class="token key atrule">repo</span><span class="token punctuation">:</span> git@git.elao.com<span class="token punctuation">:</span>&lt;vendor<span class="token punctuation">&gt;</span>/&lt;app<span class="token punctuation">&gt;</span><span class="token punctuation">-</span>release.git
    <span class="token comment">#ref: master # Based on app/mode by default</span>
    <span class="token comment"># Release</span>
    <span class="token key atrule">release_tasks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">shell</span><span class="token punctuation">:</span> make install@production
      <span class="token punctuation">-</span> <span class="token key atrule">shell</span><span class="token punctuation">:</span> make build@production
    <span class="token comment"># You can either explicitly list all the paths you want to include</span>
    <span class="token key atrule">release_add</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> bin
      <span class="token punctuation">-</span> config
      <span class="token punctuation">-</span> public
      <span class="token punctuation">-</span> src
      <span class="token punctuation">-</span> templates
      <span class="token punctuation">-</span> translations
      <span class="token punctuation">-</span> vendor
      <span class="token punctuation">-</span> composer.* <span class="token comment"># Composer.json required by src/Kernel.php to determine project root dir</span>
                   <span class="token comment"># Composer.lock required by composer on post-install (warmup)</span>
      <span class="token punctuation">-</span> Makefile

    <span class="token comment"># Or you can include all by default and only list the paths you want to exclude</span>
    <span class="token comment"># release_removed:</span>
    <span class="token comment">#   - ansible</span>
    <span class="token comment">#   - build</span>
    <span class="token comment">#   - doc</span>
    <span class="token comment">#   - node_modules</span>
    <span class="token comment">#   - tests</span>
    <span class="token comment">#   - .env.test</span>
    <span class="token comment">#   - .php_cs.dist</span>
    <span class="token comment">#   - .manala*</span>
    <span class="token comment">#   - package.json</span>
    <span class="token comment">#   - phpunit.xml.dist</span>
    <span class="token comment">#   - README.md</span>
    <span class="token comment">#   - Vagrantfile</span>
    <span class="token comment">#   - webpack.config.js</span>
    <span class="token comment">#   - yarn.lock</span>

    <span class="token comment"># Deploy</span>
    <span class="token key atrule">deploy_hosts</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">ssh_host</span><span class="token punctuation">:</span> foo<span class="token punctuation">-</span>01.bar.elao.local
        <span class="token comment">#master: true # Any custom variable are welcomed</span>
      <span class="token punctuation">-</span> <span class="token key atrule">ssh_host</span><span class="token punctuation">:</span> foo<span class="token punctuation">-</span>02.bar.elao.local
    <span class="token key atrule">deploy_dir</span><span class="token punctuation">:</span> /srv/app
    <span class="token key atrule">deploy_shared_files</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> config/parameters.yml
    <span class="token key atrule">deploy_shared_dirs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> var/log
    <span class="token key atrule">deploy_tasks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">shell</span><span class="token punctuation">:</span> make warmup@production
      <span class="token comment">#- shell: make migration@production</span>
      <span class="token comment">#  when: master | default # Conditions on custom host variables (jinja2 format)</span>
    <span class="token comment">#deploy_removed:</span>
    <span class="token comment">#  - web/app_dev.php</span>
    <span class="token key atrule">deploy_post_tasks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">shell</span><span class="token punctuation">:</span> sudo /bin/systemctl reload php8.1<span class="token punctuation">-</span>fpm
      <span class="token comment">#- shell: sudo /bin/systemctl restart supervisor</span>

  <span class="token punctuation">-</span> <span class="token key atrule">&lt;&lt;</span> <span class="token punctuation">:</span> <span class="token important">*release</span>
    <span class="token key atrule">mode</span><span class="token punctuation">:</span> staging
    <span class="token key atrule">release_tasks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">shell</span><span class="token punctuation">:</span> make install@staging
      <span class="token punctuation">-</span> <span class="token key atrule">shell</span><span class="token punctuation">:</span> make build@staging
    <span class="token comment"># Deploy</span>
    <span class="token key atrule">deploy_hosts</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">ssh_host</span><span class="token punctuation">:</span> foo.bar.elao.ninja.local
    <span class="token key atrule">deploy_tasks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">shell</span><span class="token punctuation">:</span> make warmup@staging</code></pre>
<h2 id="makefile">Makefile<a href="#makefile" class="anchor"></a></h2>
<p>Makefile targets that are supposed to be runned via docker must be prefixed.</p>
<pre class="code-multiline language-makefile"><code class="language-makefile" id="26eefa121751e343b4a2dd990d202594"><span class="token target symbol">foo</span><span class="token punctuation">:</span> SHELL <span class="token operator">:=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">or</span> <span class="token variable">$</span><span class="token punctuation">(</span>DOCKER_SHELL<span class="token punctuation">)</span>,<span class="token variable">$</span><span class="token punctuation">(</span>SHELL<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token target symbol">foo</span><span class="token punctuation">:</span>
    <span class="token comment"># Do something really foo...</span></code></pre>
<p>Ssh</p>
<pre class="code-multiline language-makefile"><code class="language-makefile" id="fff8ca7a134d45e620fa8df859671e74"><span class="token comment">#######</span>
<span class="token comment"># Ssh #</span>
<span class="token comment">#######</span>

<span class="token comment">## Ssh to staging server</span>
<span class="token target symbol">ssh@staging</span><span class="token punctuation">:</span> SHELL <span class="token operator">:=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">or</span> <span class="token variable">$</span><span class="token punctuation">(</span>DOCKER_SHELL<span class="token punctuation">)</span>,<span class="token variable">$</span><span class="token punctuation">(</span>SHELL<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token target symbol">ssh@staging</span><span class="token punctuation">:</span>
    ssh app<span class="token operator">@</span>foo.staging.elao.run

<span class="token comment"># Single host...</span>

<span class="token target symbol">ssh@production</span><span class="token punctuation">:</span> SHELL <span class="token operator">:=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">or</span> <span class="token variable">$</span><span class="token punctuation">(</span>DOCKER_SHELL<span class="token punctuation">)</span>,<span class="token variable">$</span><span class="token punctuation">(</span>SHELL<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token target symbol">ssh@production</span><span class="token punctuation">:</span>
    ...

<span class="token comment"># Multi host...</span>

<span class="token target symbol">ssh@production-01</span><span class="token punctuation">:</span> SHELL <span class="token operator">:=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">or</span> <span class="token variable">$</span><span class="token punctuation">(</span>DOCKER_SHELL<span class="token punctuation">)</span>,<span class="token variable">$</span><span class="token punctuation">(</span>SHELL<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token target symbol">ssh@production-01</span><span class="token punctuation">:</span>
    ...</code></pre>
<p>Sync</p>
<pre class="code-multiline language-makefile"><code class="language-makefile" id="238b5937ce83ac1228f809c183b529a9"><span class="token target symbol">sync@staging</span><span class="token punctuation">:</span> SHELL <span class="token operator">:=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">or</span> <span class="token variable">$</span><span class="token punctuation">(</span>DOCKER_SHELL<span class="token punctuation">)</span>,<span class="token variable">$</span><span class="token punctuation">(</span>SHELL<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token target symbol">sync@staging</span><span class="token punctuation">:</span>
    mkdir -p var
    rsync --archive --compress --verbose --delete-after \
<span class="token target symbol">        app@foo.staging.elao.run</span><span class="token punctuation">:</span>/srv/app/current/var/files/ \
        var/files/

<span class="token comment"># Multi targets...</span>
<span class="token target symbol">sync-uploads@staging</span><span class="token punctuation">:</span> SHELL <span class="token operator">:=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">or</span> <span class="token variable">$</span><span class="token punctuation">(</span>DOCKER_SHELL<span class="token punctuation">)</span>,<span class="token variable">$</span><span class="token punctuation">(</span>SHELL<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token target symbol">sync-uploads@staging</span><span class="token punctuation">:</span>
  ...

<span class="token comment"># Multi apps...</span>
<span class="token target symbol">sync.api-uploads@staging</span><span class="token punctuation">:</span> SHELL <span class="token operator">:=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">or</span> <span class="token variable">$</span><span class="token punctuation">(</span>DOCKER_SHELL<span class="token punctuation">)</span>,<span class="token variable">$</span><span class="token punctuation">(</span>SHELL<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token target symbol">sync.api-uploads@staging</span><span class="token punctuation">:</span>
  ...</code></pre>
<h3 id="git-tools">Git tools<a href="#git-tools" class="anchor"></a></h3>
<p>This recipe contains some git helpers such as the <a href="https://github.com/manala/manala-recipes/blob/master/elao.app/.manala/make/git.mk" target="_blank"><code class="code-inline" id="e6c58e1556cef6518971d204931757e6">git_diff</code></a> function.</p>
<p>This function is useful for example to apply <code class="code-inline" id="bb7790bfaa80da52ecba1a151b299b55">php-cs</code>, <code class="code-inline" id="84a40fcfe7ec43f029d5956efb08d1c2">php-cs-fix</code> or <code class="code-inline" id="b098e670cdbfc421583801f6038ae38d">PHPStan</code> checks only on the subset of updated PHP files and not on any PHP file of your project.</p>
<p>Usage (in your <code class="code-inline" id="b67911656ef5d18c4ae36cb6741b7965">Makefile</code>):</p>
<pre class="code-multiline language-makefile"><code class="language-makefile" id="e9821a313f802ec649b58e33a335fc7e"><span class="token target symbol">lint.php-cs-fixer</span><span class="token punctuation">:</span> DIFF <span class="token operator">=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">call</span> git_diff, php, src tests<span class="token punctuation">)</span>
<span class="token target symbol">lint.php-cs-fixer</span><span class="token punctuation">:</span>
    <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">if</span> <span class="token variable">$</span><span class="token punctuation">(</span>DIFF<span class="token punctuation">)</span>, \
        vendor/bin/php-cs-fixer fix --config<span class="token operator">=</span>.php_cs.dist --path-mode<span class="token operator">=</span>intersection --diff --dry-run <span class="token variable">$</span><span class="token punctuation">(</span>DIFF<span class="token punctuation">)</span>, \
        printf <span class="token string">"You have made no change in PHP files\n"</span> \
    <span class="token punctuation">)</span></code></pre>
<h3 id="try-tools">Try tools<a href="#try-tools" class="anchor"></a></h3>
<p>This recipe contains some try helpers such as the <a href="https://github.com/manala/manala-recipes/blob/master/elao.app/.manala/make/try.mk" target="_blank"><code class="code-inline" id="73691059dcea540103db82ad2b3c40f7">try_finally</code></a> function.</p>
<p>This function is useful for example to run <code class="code-inline" id="85af727fd022d3a13e7972fd6a418582">phpunit</code> tests needing a started symfony server, and to stop this server regardless of the tests return code.</p>
<p>Usage (in your <code class="code-inline" id="b67911656ef5d18c4ae36cb6741b7965">Makefile</code>):</p>
<pre class="code-multiline language-makefile"><code class="language-makefile" id="e0f9aa14ca8d2939a55c0be70ca37768"><span class="token target symbol">test.phpunit@integration</span><span class="token punctuation">:</span>
<span class="token target symbol">    symfony server</span><span class="token punctuation">:</span>start --ansi --no-humanize --daemon --no-tls --port<span class="token operator">=</span>8000
    <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">call</span> try_finally, \
        bin/phpunit --colors<span class="token operator">=</span>always --log-junit report/junit/phpunit.xml, \
<span class="token target symbol">        symfony server</span><span class="token punctuation">:</span>stop --ansi \
    <span class="token punctuation">)</span></code></pre>
<h2 id="secrets">Secrets<a href="#secrets" class="anchor"></a></h2>
<p>In order to generate secrets, use <a href="https://docs.gomplate.ca" target="_blank">Gomplate</a>, called by a make task.
Gomplate takes a template, queries its values from a Vault server and renders a file.</p>
<p>Add the following tasks in the <code class="code-inline" id="b67911656ef5d18c4ae36cb6741b7965">Makefile</code>:</p>
<pre class="code-multiline language-makefile"><code class="language-makefile" id="1715a774596725ae54a686ff3863fe0b"><span class="token comment">###########</span>
<span class="token comment"># Secrets #</span>
<span class="token comment">###########</span>

<span class="token target symbol">secrets@production</span><span class="token punctuation">:</span>
    gomplate --input-dir<span class="token operator">=</span>secrets/production --output-map<span class="token operator">=</span><span class="token string">'{{ .in | replaceAll ".gohtml" "" }}'</span>

<span class="token target symbol">secrets@staging</span><span class="token punctuation">:</span>
    gomplate --input-dir<span class="token operator">=</span>secrets/staging --output-map<span class="token operator">=</span><span class="token string">'{{ .in | replaceAll ".gohtml" "" }}'</span></code></pre>
<p>Put your templates in <code class="code-inline" id="1ca4b42ca90e819f64f33c96b270e1c1">.gohtml</code> files inside a <code class="code-inline" id="df9fb49a2fc451d46b4f322d61a159d5">secrets/[production|staging]</code> directory at the root of the project.<br>
Respect destination file names, extensions, and paths:</p>
<pre class="code-multiline language-treeview"><code class="language-treeview" id="e677d579d06fde32d814f6be1f3d6881"><span class="token treeview-part"><span class="token entry-name dir">secrets</span></span>
<span class="token treeview-part"><span class="token entry-line line-h">├── </span><span class="token entry-name dir">production</span></span>
<span class="token treeview-part"><span class="token entry-line line-v">|   </span><span class="token entry-line line-h">├── </span><span class="token entry-name ext-env-gohtml ext-gohtml dotfile">.env.gohtml</span></span>
<span class="token treeview-part"><span class="token entry-line line-v">|   </span><span class="token entry-line line-v-last">└── </span><span class="token entry-name dir">config</span></span>
<span class="token treeview-part"><span class="token entry-line line-v">|   </span><span class="token entry-line line-v-gap">    </span><span class="token entry-line line-v-last">└── </span><span class="token entry-name ext-yaml-gohtml ext-gohtml">parameters.yaml.gohtml</span></span>
<span class="token treeview-part"><span class="token entry-line line-v-last">└── </span><span class="token entry-name dir">staging</span></span>
<span class="token treeview-part"><span class="token entry-line line-v-gap">    </span><span class="token entry-line line-h">├── </span><span class="token entry-name ext-env-gohtml ext-gohtml dotfile">.env.gohtml</span></span>
<span class="token treeview-part"><span class="token entry-line line-v-gap">    </span><span class="token entry-line line-v-last">└── </span><span class="token entry-name dir">config</span></span>
<span class="token treeview-part"><span class="token entry-line line-v-gap">    </span><span class="token entry-line line-v-gap">    </span><span class="token entry-line line-v-last">└── </span><span class="token entry-name ext-yaml-gohtml ext-gohtml">parameters.yaml.gohtml</span></span></code></pre>
<p>Here are some template examples:</p>
<p><code class="code-inline" id="f2af2f04aef6d83d08a8b60fd1fb4e3b">production/.env.gohtml</code>:</p>
<pre class="code-multiline language-twig"><code class="language-twig" id="f953d0deef67415a83b9abe850c4489e"># This file was generated by Gomplate from Vault secrets for production
<span class="token twig language-twig"><span class="token delimiter punctuation">{{-</span> range $key<span class="token punctuation">,</span> $value <span class="token punctuation">:</span><span class="token operator">=</span> <span class="token punctuation">(</span>datasource <span class="token string"><span class="token punctuation">"</span>vault:///foo_bar/data/env<span class="token punctuation">"</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>data <span class="token delimiter punctuation">}}</span></span>
<span class="token twig language-twig"><span class="token delimiter punctuation">{{</span> $key <span class="token delimiter punctuation">}}</span></span>=<span class="token twig language-twig"><span class="token delimiter punctuation">{{</span> $value <span class="token operator">|</span> quote <span class="token delimiter punctuation">}}</span></span>
<span class="token twig language-twig"><span class="token delimiter punctuation">{{-</span> end <span class="token delimiter punctuation">}}</span></span></code></pre>
<p><code class="code-inline" id="ace3554d73f8fcf79511d0c4a3377b0c">staging/.env.gohtml</code>:</p>
<pre class="code-multiline language-twig"><code class="language-twig" id="c86051013d56a285694980972e2e28a3"># This file was generated by Gomplate from Vault secrets for staging
<span class="token twig language-twig"><span class="token delimiter punctuation">{{-</span> range $key<span class="token punctuation">,</span> $value <span class="token punctuation">:</span><span class="token operator">=</span> <span class="token punctuation">(</span>datasource <span class="token punctuation">(</span>print <span class="token string"><span class="token punctuation">"</span>vault:///foo_bar/data/env<span class="token punctuation">"</span></span> <span class="token punctuation">(</span>has <span class="token punctuation">.</span>Env <span class="token string"><span class="token punctuation">"</span>STAGE<span class="token punctuation">"</span></span> <span class="token operator">|</span> ternary <span class="token punctuation">(</span>printf <span class="token string"><span class="token punctuation">"</span>-%s<span class="token punctuation">"</span></span> <span class="token punctuation">(</span>getenv <span class="token string"><span class="token punctuation">"</span>STAGE<span class="token punctuation">"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token string"><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data <span class="token delimiter punctuation">}}</span></span>
<span class="token twig language-twig"><span class="token delimiter punctuation">{{</span> $key <span class="token delimiter punctuation">}}</span></span>=<span class="token twig language-twig"><span class="token delimiter punctuation">{{</span> $value <span class="token operator">|</span> quote <span class="token delimiter punctuation">}}</span></span>
<span class="token twig language-twig"><span class="token delimiter punctuation">{{-</span> end <span class="token delimiter punctuation">}}</span></span></code></pre>
<p>Note the <code class="code-inline" id="37e72e88b86734bddeb33b073fd443d1">STAGE</code> environnement variable usage, allowing to switch from <code class="code-inline" id="ff035a1dd7655da15295fa5fa89362a7">env</code> to <code class="code-inline" id="dbe9a0b5a22ed642b74b89f294df3eae">env-${STAGE}</code> vault secret, calling <code class="code-inline" id="5b1f62bc5f1bd2d9dd5a4dba03712824">make secrets@staging STAGE=foo</code>.</p>
<p><code class="code-inline" id="aea29b0f092fc172aeb04f87eca66fe2">production/config/parameters.yaml.gohtml</code>:</p>
<pre class="code-multiline language-twig"><code class="language-twig" id="ad18bf03d350b23f0543d983de4c1f0e"># This file was generated by Gomplate from Vault secrets for production
parameters:
<span class="token twig language-twig"><span class="token delimiter punctuation">{{</span> <span class="token punctuation">(</span>datasource <span class="token string"><span class="token punctuation">"</span>vault:///foo_bar/data/parameters<span class="token punctuation">"</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>data <span class="token operator">|</span> toYAML <span class="token operator">|</span> indent <span class="token number">4</span> <span class="token delimiter punctuation">-}}</span></span></code></pre>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>
    Note that the path to the secret will slightly differ from what the Vault server will display:<br>
    if the path is <code class="code-inline" id="64c63aa5770c80950856a62d52f3197e">MyApp/production/env</code> on the Vault server,
    it will become <code class="code-inline" id="d1fe1e84e8be71210179d429f6295150">MyApp/data/production/env</code> in the template
</p>
</div>
<p>See <a href="https://docs.gomplate.ca/syntax/" target="_blank">Go Template syntax</a> for more info.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>
    Make sure to include the <code class="code-inline" id="7de38f3c3d3baa7ca58a366f09577586">secrets</code> directory into your release, using the <code class="code-inline" id="0daf67ed1fa9305d63925bc08acf9c96">release_add</code> entry.
</p>
</div>
<h2 id="https">Https<a href="#https" class="anchor"></a></h2>
<p>In  order for https to work properly, you must:</p>
<ol>
<li>
<p>ensure elao ca certificate has been added to your local keychain (one time for <em>all</em> projects)</p>
<pre class="code-multiline language-shell"><code class="language-shell" id="c3dcbef8d973dace788b1dd85bc3c3ee">$ <span class="token function">sudo</span> security add-trusted-cert -d -r trustRoot -k <span class="token string">"/Library/Keychains/System.keychain"</span> .manala/certificates/ca.crt</code></pre>
</li>
<li>
<p>generate a project certificate (one time <em>by</em> project, inside vagrant, remember to commit them right after)</p>
<pre class="code-multiline language-shell"><code class="language-shell" id="eeb3e472903f3360f248e70679e0438b">⇒  <span class="token function">make</span> provision.certificates</code></pre>
</li>
<li>
<p>For firefox only, browse to <code class="code-inline" id="e43648ef7c80e1a6aa2fc5e3182ed187">about:config</code> and ensure <code class="code-inline" id="40169ca3c0758a897e82d7000d02abe3">security.enterprise_roots.enabled</code> value is set to true</p>
</li>
</ol>
<h2 id="tips-tricks-and-tweaks">Tips, Tricks, and Tweaks<a href="#tips-tricks-and-tweaks" class="anchor"></a></h2>
<ul>
<li><a href="https://www.vagrantup.com/docs/synced-folders/nfs.html#root-privilege-requirement" target="_blank">Vagrant root privilege requirement</a></li>
<li>
<p>Debug ansible provisioning:</p>
<pre class="code-multiline language-shell"><code class="language-shell" id="5ed0125f03431e6a4f2df8fd17f0e610">ansible-galaxy collection <span class="token function">install</span> manala.roles --collections-path /vagrant/ansible/collections</code></pre>
</li>
</ul></body>
        </article>
    </section>

    <time datetime="2023-03-03UTC09:22:10+00:00">Last modified: March 3, 2023 09:22</time>
        </div>

        <footer class="footer">
            <div class="container">
                <div class="row">
                    <div class="col-sm-4 no-pb">
                        <a href="https://manala.io" class="manala"><img src="/manala-recipes/build/images/manala.053e7ef8.svg" width="56" height="56" title="Manala.io" alt="Manala.io"> Manala.io</a>
                    </div>
                    <div class="col-sm-4 no-pb github text-center">
                        <a href="https://github.com/manala/manala-recipes" target="_blank"><img src="/manala-recipes/build/images/github.04ed74f3.svg" width="32" height="32" title="Manala on Github" alt="Manala recipes on Github"></a>
                    </div>
                    <div class="col-sm-4 no-pb elao">
                        Made with love by <a href="https://www.elao.com" target="_blank"><img src="/manala-recipes/build/images/elao.91d6ac3c.svg" width="64" height="23" title="élao" alt="élao"></a>
                        <small>(and <a target="_blank" href="https://www.rix.fr/"><strong>Rix</strong></a> !)</small>
                    </div>
                </div>
            </div>
        </footer>
    </body>
</html>
