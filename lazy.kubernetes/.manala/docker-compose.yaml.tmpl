{{- $now := dateInZone "20060102150405" (now) "UTC" -}}

version: "3.7"

services:

    ##########
    # System #
    ##########

    system:
        hostname: {{ .Vars.project.name }}
        build:
            context: .
            target: system
        image: {{ .Vars.project.name }}:{{ $now }}
        volumes:
            - ..:${DIR}
            {{- range $mount := .Vars.system.mount }}
            - ../{{ $mount }}:${DIR}/{{ $mount }}
            {{- end }}
        environment:
            DIR: ${DIR}
            CACHE_DIR: ${CACHE_DIR}
            {{- .Vars.system.env | toYaml | nindent 12 }}
        {{- if .Vars.system.env_file }}
        {{- if kindIs "slice" .Vars.system.env_file }}
        env_file:
            {{- range $file := .Vars.system.env_file }}
            - ../{{ $file }}
            {{- end }}
        {{- else }}
        env_file: ../{{ .Vars.system.env_file }}
        {{- end }}
        {{- end }}
        working_dir: ${DIR}
        entrypoint: .manala/docker/entrypoint
        # Use default docker bridge network
        network_mode: bridge
