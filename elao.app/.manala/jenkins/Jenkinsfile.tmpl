#!/usr/bin/env groovy

pipeline {
  agent {
      dockerfile {
          dir '.manala/docker'
      }
  }
  stages {
    {{- range $stage := .Vars.integration.stages }}
    stage('{{ $stage.label }}') {
      parallel {
        {{- range $track := $stage.tracks }}
        stage('
          {{- if hasKey $track "label" -}}
            {{ $track.label }}
          {{- else if hasKey $track "app" -}}
            {{ $track.app | title }}
          {{- else -}}
            App
          {{- end -}}
        ') {
          stages {
            {{- range $step := $track.steps }}
            stage('{{ $step.label }}') {
              steps {
                {{- if hasKey $track "app" }}
                  dir('{{ $track.app }}') {
                    {{- range $task := $step.tasks }}
                    sh '{{ $task }}'
                    {{- end }}
                  }
                {{- else }}
                {{- range $task := $step.tasks }}
                sh '{{ $task }}'
                {{- end }}
                {{- end }}
              }
            }
            {{- end }}
          }
        }
        {{- end }}
      }
    }
    {{- end }}
  }
  post {
    always {
      junit testResults: '**/report/junit/*.xml', allowEmptyResults: true
    }
  }
}
