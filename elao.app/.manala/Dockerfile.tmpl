FROM debian:{{ .Vars.system.version }}-slim

RUN \
    apt-get update \
    && apt-get install --yes --no-install-recommends \
        sudo \
        curl ca-certificates \
        gnupg \
        bash-completion \
        make \
    # Starship
    && curl -sSL https://github.com/starship/starship/releases/latest/download/starship-$(uname -m)-unknown-linux-musl.tar.gz \
        | tar zxf - -C /usr/local/bin \
    # User
    && addgroup --gid 1000 app \
    && adduser --disabled-password --gecos "" app --uid 1000 --ingroup app \
    && printf "app ALL=(ALL) NOPASSWD:ALL\n" \
        > /etc/sudoers.d/app \
    && printf "eval \"\$(starship init bash)\"\n" \
        >> /home/app/.bashrc \
    # Systemd
    && apt-get install --yes --no-install-recommends \
        systemd dbus \
    && systemctl set-default multi-user.target \
    && sed -i 's/#\(ForwardToConsole=\).*$/\1yes/' \
        /etc/systemd/journald.conf \
    && printf "Defaults env_keep += \"container\"\n" \
        > /etc/sudoers.d/systemd \
    && rm -rf \
        /etc/systemd/system/*.wants/* \
        /lib/systemd/system/multi-user.target.wants/* \
        /lib/systemd/system/local-fs.target.wants/* \
        /lib/systemd/system/sockets.target.wants/*udev* \
        /lib/systemd/system/sockets.target.wants/*initctl* \
        /lib/systemd/system/sysinit.target.wants/systemd-tmpfiles-setup-dev* \
        /lib/systemd/system/systemd-update-utmp*

# Systemd
ENV container docker
VOLUME /sys/fs/cgroup
CMD ["/lib/systemd/systemd"]
STOPSIGNAL SIGRTMIN+3

# Ansible
RUN \
    apt-get install --yes --no-install-recommends \
        zstd \
    && curl -sSL https://github.com/indygreg/python-build-standalone/releases/download/20210724/cpython-3.9.6-$(uname -m)-unknown-linux-gnu-lto-20210724T1424.tar.zst \
        | tar -I zstd -xf - -C /opt --strip-components=2 --one-top-level=python3.9 python/install \
    && /opt/python3.9/bin/python3 -m venv /opt/ansible \
    && /opt/ansible/bin/pip install ansible-core==2.11.5  \
    && ln --symbolic --target-directory /usr/local/bin \
        /opt/ansible/bin/ansible \
        /opt/ansible/bin/ansible-galaxy \
        /opt/ansible/bin/ansible-playbook \
    && mkdir -p /etc/ansible \
    && printf "\
[defaults]\n\
force_color = True\n\
gather_subset = all,!hardware\n\
display_skipped_hosts = False\n\
retry_files_enabled = False\n\
collections_path = /usr/share/ansible/collections\n" \
        > /etc/ansible/ansible.cfg

WORKDIR /srv/app

COPY . ./.manala/

# Provision
RUN \
    make --silent --directory .manala provision
