{{- $now := dateInZone "20060102150405" (now) "UTC" -}}

name: {{ .Vars.project.name | replace "." "-" }}

services:

    ##########
    # System #
    ##########

    system:
        hostname: {{ .Vars.project.name }}
        build:
            context: ..
            dockerfile: docker/Dockerfile
        image: {{ .Vars.project.name }}:{{ $now }}
        volumes:
            - ../..:${MANALA_DIR}
            {{- range $mount := .Vars.system.mount }}
              {{- if isAbs $mount }}
            - {{ $mount }}:{{ $mount }}
              {{- else }}
            - ../../{{ $mount }}:${MANALA_DIR}/{{ $mount }}
              {{- end }}
            {{- end }}
        environment:
            MANALA_DIR: ${MANALA_DIR}
            MANALA_CACHE_DIR: ${MANALA_CACHE_DIR}
            {{- if .Vars.system.env }}
            {{- .Vars.system.env | toYaml | nindent 12 }}
            {{- end }}
        {{- if .Vars.system.env_file }}
        {{- if kindIs "slice" .Vars.system.env_file }}
        env_file:
            {{- range $file := .Vars.system.env_file }}
            - ../../{{ $file }}
            {{- end }}
        {{- else }}
        env_file: ../../{{ .Vars.system.env_file }}
        {{- end }}
        {{- end }}
        working_dir: ${MANALA_DIR}
        # Use default docker bridge network
        network_mode: bridge
