#!/bin/sh

set -e

# Ssh agent bridge
if [ -n "${SSH_AUTH_SOCK}" ]; then
  sh -c " \
    while true; do \
      rm -f /var/run/ssh-auth-bridge.sock ;
{{- if le (.Vars.system.version|int) 12 }}
      socat \
{{- else }}
      socat -d0 \
{{- end }}
        UNIX-LISTEN:/var/run/ssh-auth-bridge.sock,fork,mode=777 \
        UNIX-CONNECT:/var/run/ssh-auth.sock ; \
      sleep 1; \
    done \
  " &
fi

# Docker bridge
if [ -n "${DOCKER_HOST}" ]; then
  sh -c " \
    while true; do \
      rm -f /var/run/docker-bridge.sock ;
{{- if le (.Vars.system.version|int) 12 }}
      socat -t 600 \
{{- else }}
      socat -d0 -t 600 \
{{- end }}
        UNIX-LISTEN:/var/run/docker-bridge.sock,fork,mode=777 \
        UNIX-CONNECT:/var/run/docker.sock ; \
      sleep 1; \
    done \
  " &
fi

exec "$@"
