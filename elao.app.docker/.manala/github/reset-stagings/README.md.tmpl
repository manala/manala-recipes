# Reset stagings

{{- if not .Vars.deliveries }}

¯\_(ツ)_/¯ Because it works on my machine...

{{- else }}

## Usage

{{- /* Guess apps */ -}}
{{- $apps := list -}}
{{- range $delivery := .Vars.deliveries -}}
  {{- if hasKey $delivery "app" -}}
    {{- $apps = (append $apps $delivery.app) | uniq -}}
  {{- end -}}
{{- end -}}

{{- /* Guess main branch */ -}}
{{- $mainBranch := "master" -}}
{{- range $delivery := .Vars.deliveries -}}
  {{- if hasKey $delivery "ref" -}}
    {{- if eq $delivery.tier "production" -}}
      {{- $mainBranch = $delivery.ref -}}
    {{- end -}}
  {{- end -}}
{{- end }}

{{- /* Guess tiers */ -}}
{{- $tiers := list -}}
{{- range $delivery := .Vars.deliveries -}}
  {{- $tiers = (append $tiers $delivery.tier) | uniq -}}
{{- end }}
{{- $tiers = without $tiers "production" -}}

`.github/workflows/reset-stagings.yaml`:

```yaml
name: Reset stagings
run-name: {{ `${{ format('Reset {0} branche(s)', github.event.inputs.tiers == 'all' && 'all stagings' || github.event.inputs.tiers) }}` }}

on:
  workflow_dispatch:
    inputs:
      tiers:
        description: Tier branches to reset
        type: choice
        options: [all, {{ $tiers | join ", " }}]
        required: true
      ref:
        description: Git reference.
        default: {{ $mainBranch }}
        required: true
      comment:
        description: Add a comment to notify opened PRs
        type: boolean
        default: true
        required: false
      deploy:
        description: Re-release and deploy the branches with the new code
        type: boolean
        default: false
        required: false

concurrency:
  group: {{ `${{ github.workflow }}-${{ github.ref }}-${{ github.event.inputs.tiers }}` }}
  cancel-in-progress: true

jobs:
  matrix:
    name: 'Compute matrix'
    runs-on: ubuntu-latest
    outputs:
      matrix: {{ `${{ steps.set-matrix.outputs.matrix }}` }}

    steps:
      - name: 'Compute matrix'
        id: set-matrix
        run: |
          matrix='{{ `${{ github.event.inputs.tiers == 'all' && '{ "tier": ^tiers^ }' || format('{{ "tier"{0} ["{1}"] }}', ':', github.event.inputs.tiers) }}` | replace "^tiers^" ($tiers | toJson) }}'
          echo $matrix
          echo $matrix | jq .
          echo "matrix=$matrix" >> $GITHUB_OUTPUT

  reset:
    needs: matrix
    name: 'Reset {{ `${{ matrix.tier }}` }} branch'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      # https://github.blog/changelog/2020-04-15-github-actions-new-workflow-features/#new-fromjson-method-in-expressions
      matrix: {{ `${{ fromJson(needs.matrix.outputs.matrix) }}` }}
    env:
      GH_TOKEN: {{ `${{ secrets.GITHUB_TOKEN }}` }}

    steps:
      - name: {{ `'Reset hard ${{ matrix.tier }} branch on ${{ github.event.inputs.ref }}'` }}
        uses: nicksnell/action-reset-repo@master
        with:
          github_token: {{ `${{ secrets.GITHUB_TOKEN }}` }}
          base_branch: {{ `${{ github.event.inputs.ref }}` }}
          reset_branch: {{ `${{ matrix.tier }}` }}

      - name: 'Find PRs with label {{ `${{ matrix.tier }}` }}'
        id: find-prs
        run: |
          prs=$(gh pr list --label '{{ `${{ matrix.tier }}` }}' --json=number --state open | jq -cr '.|map(.number)')
          echo $prs
          echo $prs | jq .
          echo "prs=$prs" >> $GITHUB_OUTPUT

      - name: 'Labelize opened PRs with label {{ `${{ matrix.tier }}` }}'
        run: |
          echo {{ `${{ steps.find-prs.outputs.prs }}` }} | jq -c '.[]' | while read pr; do
            gh pr view $pr --json=number,title || true
            gh pr edit $pr --remove-label {{ `${{ matrix.tier }}` }} || true
            gh pr edit $pr --add-label {{ `${{ matrix.tier }}` }}-reset || true
          done

      - name: 'Notify opened PRs with label {{ `${{ matrix.tier }}` }}'
        if: success() && github.event.inputs.comment == 'true'
        run: |
          echo {{ `${{ steps.find-prs.outputs.prs }}` }} | jq -c '.[]' | while read pr; do
            gh pr view $pr --json=number,title
            {{ `gh pr comment $pr --body "> **Warning** la branche ^b^${{ matrix.tier }}^b^ a été reset. Cette PR doit à nouveau être mergée sur ^b^${{ matrix.tier }}^b^"`| replace "^b^" "\\`" }}
          done

  deploy:
    if: success() && github.event.inputs.deploy == 'true'
    needs: [matrix, reset]
    name: 'Re-release & deploy {{ `${{ matrix.tier }}` }} branch'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      # https://github.blog/changelog/2020-04-15-github-actions-new-workflow-features/#new-fromjson-method-in-expressions
      matrix: {{ `${{ fromJson(needs.matrix.outputs.matrix) }}` }}
    env:
      GH_TOKEN: {{ `${{ secrets.GITHUB_TOKEN }}` }}

    steps:
      - name: 'Checkout'
        uses: actions/checkout@v3

      - name: 'Trigger release workflow for back@{{ `${{ matrix.tier }}` }}'
        run: |
          gh workflow run release \
              --field deploy=true \
              --field app=back \
              --field tier={{ `${{ matrix.tier }}` }}
```

{{- end }}
