{{- $apps := list -}}
{{- range $delivery := .Vars.deliveries -}}
{{- if hasKey $delivery "app" -}}
{{- $apps = (append $apps $delivery.app) | uniq -}}
{{- end -}}
{{- end -}}

name: Release
description: Release
author: Elao

inputs:
  secrets:
    description: Secrets
    required: true
  app:
    description: App
    required: false
  tier:
    description: Tier
    required: true
  ref:
    description: Ref
    required: false
  release:
    description: Release
    type: boolean
    default: {{ `${{ github.job == 'release' && 'true' || 'false' }}` }}
  deploy:
    description: Deploy
    type: boolean
    default: {{ `${{ github.job == 'deploy' && 'true' || 'false' }}` }}
  deploy_ref:
    description: Deploy Ref
    required: false
  env:
    description: Env vars as a single string
    required: false
    default: ''

outputs:
  deployment_url:
    description: The deployed app URL
    {{- if $apps }}
    value: {{ `${{ steps[format('deployment_url_{0}_{1}', inputs.app, inputs.tier)].outputs.deployment_url }}` }}
    {{- else }}
    value: {{ `${{ steps[format('deployment_url_{0}', inputs.tier)].outputs.deployment_url }}` }}
    {{- end }}

runs:
  using: composite
  steps:

    {{- range $i, $delivery := .Vars.deliveries }}
    {{- $delivery_name := $delivery.tier }}
    {{- $delivery_if := printf "inputs.tier == '%s'" $delivery.tier }}
    {{- $delivery_id_suffix := $delivery.tier }}
    {{- if hasKey $delivery "app" }}
      {{- $delivery_name = printf "%s@%s" $delivery.app $delivery.tier }}
      {{- $delivery_if = printf "inputs.app == '%s' && inputs.tier == '%s'" $delivery.app $delivery.tier }}
      {{- $delivery_id_suffix = printf "%s_%s" $delivery.app $delivery.tier }}
    {{- end }}
    {{- $delivery_ref := printf "${{ inputs.ref || '%s' }}" (or (get $delivery "ref") "master") }}

    ##{{ repeat (len $delivery_name) "#" }}##
    # {{ $delivery_name }} #
    ##{{ repeat (len $delivery_name) "#" }}##

    - name: Checkout {{ $delivery_name }} (ref "{{ $delivery_ref }}")
      if: {{ $delivery_if }}
      uses: actions/checkout@v3
      with:
        ref: {{ $delivery_ref }}

    - name: Setup {{ $delivery_name }}
      if: {{ $delivery_if }}
      uses: ./.manala/github/system
      with:
        setup: true
        env: {{ `${{ inputs.env }}` }}
        {{- if hasKey $delivery "github_ssh_key_secret" }}
        ssh_key: {{ printf "${{ fromJSON(inputs.secrets).%s }}" $delivery.github_ssh_key_secret }}
        {{- end }}

    - name: Release {{ $delivery_name }}
      if: >
        {{ $delivery_if }}
        && inputs.release != 'false'
      uses: ./.manala/github/system
      with:
        {{- if hasKey $delivery "app" }}
        app: {{ $delivery.app }}
        {{- end }}
        shell_group: ðŸ“¦ Release
        shell: |
          make release{{ include "delivery_target" $delivery }} \
            AUTHOR="manala-ci-releaser <{{ `${{ github.actor }}` }}+github@manala.io>"

    - name: Set deployment URL for {{ $delivery_name }}
      if: >
        {{ $delivery_if }}
        && inputs.deploy != 'false'
      id: deployment_url_{{ $delivery_id_suffix }}
      shell: bash
      {{- if hasKey $delivery "deploy_url" }}
      run: echo "deployment_url={{ $delivery.deploy_url }}" >> $GITHUB_OUTPUT
      {{- else }}
      run: echo "deployment_url=" >> $GITHUB_OUTPUT
      {{- end }}

    - name: Deploy {{ $delivery_name }}
      if: >
        {{ $delivery_if }}
        && inputs.deploy != 'false'
      uses: ./.manala/github/system
      with:
        {{- if hasKey $delivery "app" }}
        app: {{ $delivery.app }}
        {{- end }}
        shell_group: ðŸš€ Deploy
        shell: |
          make deploy{{ include "delivery_target" $delivery }} \
            {{ `${{ inputs.deploy_ref != '' && format('REF={0}', inputs.deploy_ref) || '' }}` }}

    {{- end }}
